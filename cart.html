<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title data-i18n="meta.title">Livi Jewelry — Корзина</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="shortcut icon" href="assets/logo.png">

  <!-- Google tag (gtag.js) — GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4H6HK8K9SJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-4H6HK8K9SJ');

    // Google Ads conversion (WhatsApp)
    function gtag_report_conversion(url) {
      var callback = function () { if (typeof url !== 'undefined') window.location = url; };
      gtag('event', 'conversion', { 'send_to':'AW-16793974126/MuJ_CObHup8bEO7q_sc-', 'event_callback': callback });
      return false;
    }
  </script>

  <style>
    :root{--fg:#111;--muted:#666;--line:#eee;--radius:16px;--shadow:0 8px 28px rgba(0,0,0,.08);--max:1240px}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font:16px/1.6 "Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--fg)}
    a{text-decoration:none;color:inherit}

    /* Header with burger + cart (cart stays right) */
    header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.95);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--line)}
    .nav{max-width:var(--max);margin:0 auto;padding:12px 16px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px}
    .hamburger{width:42px;height:42px;border-radius:12px;border:1px solid var(--line);background:#fff;display:inline-grid;place-items:center;cursor:pointer}
    .hamburger span{width:18px;height:2px;background:#111;display:block;position:relative}
    .hamburger span::before,.hamburger span::after{content:"";position:absolute;left:0;width:18px;height:2px;background:#111}
    .hamburger span::before{top:-6px}.hamburger span::after{top:6px}
    .brand{justify-self:center;display:flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.06em}
    .brand img{height:24px}
    .cart-link{justify-self:end;position:relative;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
    .cart-badge{position:absolute;top:-6px;right:-6px;background:#111;color:#fff;border-radius:999px;font-size:12px;line-height:1;padding:4px 6px;min-width:20px;text-align:center;display:none}

    /* Drawer */
    .drawer{position:fixed;inset:0;z-index:100;display:none}
    .drawer.open{display:block}
    .drawer-back{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .drawer-panel{position:absolute;left:10px;top:10px;bottom:10px;width:min(86vw,320px);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px}
    .drawer a,.drawer button{display:block;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;text-align:left;cursor:pointer}
    .lang{display:flex;gap:8px}.lang button{flex:1}

    .wrap{max-width:960px;margin:0 auto;padding:28px 16px}
    h1{font-size:clamp(24px,5vw,40px);margin-bottom:20px;text-align:center}

    .empty{padding:28px;border:1px dashed var(--line);border-radius:16px;text-align:center;color:var(--muted)}
    .list{display:grid;gap:14px;margin:18px 0}
    .item{display:grid;grid-template-columns:96px 1fr auto auto;gap:12px;align-items:center;border:1px solid var(--line);border-radius:var(--radius);padding:12px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.04)}
    .thumb{width:96px;height:96px;border-radius:12px;overflow:hidden;background:#f5f5f5}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .title{font-weight:600}
    .muted{color:var(--muted);font-size:14px}
    .qty{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .btn--primary{background:#111;color:#fff;border-color:#111}
    .total{display:flex;justify-content:space-between;align-items:center;margin-top:20px;border-top:1px solid var(--line);padding-top:14px;font-size:18px;font-weight:600}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    @media(max-width:560px){
      .item{grid-template-columns:72px 1fr;grid-template-areas:"thumb title" "thumb qty" "thumb del";align-items:start}
      .thumb{width:72px;height:72px}
      .actions .btn{width:100%}
    }
  </style>
</head>
<body>
  <!-- Drawer -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-back"></div>
    <div class="drawer-panel" role="menu" aria-label="Меню">
      <a href="index.html" data-i18n="nav.home">Главная</a>
      <a href="shop.html" data-i18n="nav.shop">Каталог</a>
      <a href="https://instagram.com/livi_jwl" target="_blank" rel="noopener">Instagram</a>
      <a href="https://wa.me/77054510584?text=Здравствуйте!%20Хочу%20украшение%20Livi%20Jewelry." target="_blank" rel="noopener" onclick="return gtag_report_conversion(this.href);">WhatsApp</a>
      <div class="lang"><button id="ruBtn">RU</button><button id="kkBtn">KZ</button><button id="enBtn">EN</button></div>
    </div>
  </div>

<header>
  <div class="nav">
    <button id="burger" class="hamburger" aria-label="Меню"><span></span></button>
    <a class="brand" href="index.html"><img src="assets/logo.png" alt="" onerror="this.style.display='none'"><span>LIVI JEWELRY</span></a>
    <a class="cart-link" href="cart.html" data-i18n="nav.cart">Корзина <span id="cartBadge" class="cart-badge">0</span></a>
  </div>
</header>

<main class="wrap">
  <h1 data-i18n="page.title">Корзина</h1>
  <div id="root"></div>
</main>

<script>
  /* ===== i18n ===== */
  const I18N={
    ru:{'meta.title':'Livi Jewelry — Корзина','nav.home':'Главная','nav.shop':'Каталог','nav.cart':'Корзина','page.title':'Корзина',
        'empty':'Ваша корзина пуста.','go':'Перейти в каталог','total':'Итого:','clear':'Очистить','checkout':'Оформить в WhatsApp','remove':'Удалить'},
    kk:{'meta.title':'Livi Jewelry — Себет','nav.home':'Басты бет','nav.shop':'Дүкен','nav.cart':'Себет','page.title':'Себет',
        'empty':'Себет бос.','go':'Дүкенге өту','total':'Барлығы:','clear':'Тазарту','checkout':'WhatsApp арқылы рәсімдеу','remove':'Жою'},
    en:{'meta.title':'Livi Jewelry — Cart','nav.home':'Home','nav.shop':'Shop','nav.cart':'Cart','page.title':'Cart',
        'empty':'Your cart is empty.','go':'Go to catalog','total':'Total:','clear':'Clear','checkout':'Checkout via WhatsApp','remove':'Remove'}
  };
  function lang(){ return localStorage.getItem('lang') || 'ru'; }
  function setLang(l){ localStorage.setItem('lang',l); applyLang(); render(); }
  function tr(k){ return (I18N[lang()]&&I18N[lang()][k]) || (I18N['ru']&&I18N['ru'][k]) || k; }
  function applyLang(){
    document.title = tr('meta.title'); document.documentElement.lang = lang();
    document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = tr(el.getAttribute('data-i18n')); });
    [ruBtn,kkBtn,enBtn].forEach(b=>b.classList.remove('active')); (lang()==='kk'?kkBtn:lang()==='en'?enBtn:ruBtn).classList.add('active');
  }

  // Drawer + lang
  const drawer=document.getElementById('drawer'), burger=document.getElementById('burger');
  const ruBtn=document.getElementById('ruBtn'), kkBtn=document.getElementById('kkBtn'), enBtn=document.getElementById('enBtn');
  burger.onclick=()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
  drawer.querySelector('.drawer-back').onclick=()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
  ruBtn.onclick=()=>setLang('ru'); kkBtn.onclick=()=>setLang('kk'); enBtn.onclick=()=>setLang('en');

  /* ===== Cart logic ===== */
  const KEY='livi_cart_v2';

  function parseFirstKZT(priceStr){
    const m = String(priceStr||'').match(/([\d\s.,]+)\s*тг/i);
    if(!m) return 0;
    return parseInt(m[1].replace(/[^\d]/g,''),10) || 0;
  }
  function unitPrice(item){ return (typeof item.unit==='number') ? item.unit : parseFirstKZT(item.price); }

  // миграция unit
  (function migrate(){
    let cart; try{ cart=JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ cart=[]; }
    let changed=false; for(const it of cart){ if(typeof it.unit!=='number'){ it.unit=parseFirstKZT(it.price); changed=true; } }
    if(changed) localStorage.setItem(KEY, JSON.stringify(cart));
  })();

  function read(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return []} }
  function write(v){ localStorage.setItem(KEY, JSON.stringify(v)); render(); }

  function updateBadge(){
    const count = read().reduce((s,i)=>s+Number(i.qty||0),0);
    const b=document.getElementById('cartBadge'); if(!b) return;
    b.style.display = count>0 ? 'inline-block':'none'; if(count>0) b.textContent = count;
  }
  window.addEventListener('storage', e=>{ if(e.key===KEY) updateBadge(); });

  function render(){
    const root=document.getElementById('root');
    const cart=read();

    if(cart.length===0){
      root.innerHTML = `<div class="empty">${tr('empty')}<br><br><a href="shop.html">${tr('go')}</a></div>`;
      updateBadge(); return;
    }

    const list=document.createElement('div'); list.className='list';
    let total=0;

    cart.forEach((i,idx)=>{
      const unit = unitPrice(i);
      total += unit * Number(i.qty||0);

      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `
        <div class="thumb"><img src="${i.img}" alt="" onerror="this.onerror=null;this.src='assets/placeholder.jpg'"></div>
        <div><div class="title">${i.title||''}</div><div class="muted">${i.price||''}</div></div>
        <div class="qty">
          <button class="btn" aria-label="minus">−</button>
          <span>${i.qty}</span>
          <button class="btn" aria-label="plus">+</button>
        </div>
        <button class="btn" aria-label="remove">${tr('remove')}</button>
      `;
      const [minusBtn, qtyEl, plusBtn] = row.querySelectorAll('.qty .btn, .qty span');
      minusBtn.onclick=()=>{ const c=read(); if(c[idx].qty>1)c[idx].qty--; else c.splice(idx,1); write(c); };
      plusBtn.onclick =()=>{ const c=read(); c[idx].qty++; write(c); };
      row.querySelector('[aria-label="remove"]').onclick=()=>{ const c=read(); c.splice(idx,1); write(c); };
      list.appendChild(row);
    });

    const totalEl=document.createElement('div'); totalEl.className='total';
    totalEl.innerHTML = `<div>${tr('total')}</div><div>${total.toLocaleString('ru-RU')} тг</div>`;

    const actions=document.createElement('div'); actions.className='actions';
    actions.innerHTML = `
      <button class="btn" id="clear">${tr('clear')}</button>
      <a class="btn btn--primary" id="wa" target="_blank" rel="noopener"
         onclick="return gtag_report_conversion(this.href);">${tr('checkout')}</a>
    `;

    root.innerHTML=''; root.appendChild(list); root.appendChild(totalEl); root.appendChild(actions);

    document.getElementById('clear').onclick=()=>write([]);

    const text = encodeURIComponent(
      (lang()==='en'?'Hello! I want to place an order:\n\n':lang()==='kk'?'Сәлем! Тапсырыс бергім келеді:\n\n':'Здравствуйте! Хочу оформить заказ:\n\n')
      + cart.map(i=>`• ${i.title} — ${i.price} × ${i.qty}`).join('\n'));
    document.getElementById('wa').href = 'https://wa.me/77054510584?text='+text;

    updateBadge(); applyLang();
  }

  applyLang(); render();
</script>
</body>
</html>
